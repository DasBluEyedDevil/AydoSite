# Google Sheets and Google Docs Integration Guide

This guide explains how to set up and use the Google Sheets and Google Docs integration for the Employee Portal.

## Overview

The Employee Portal now supports sourcing data from Google Sheets and Google Docs, allowing non-technical users to update content without modifying code. This integration enables:

1. **Employee Database**: Source employee data from a Google Sheet
2. **Operations, Career Paths, and Events**: Source content from Google Docs

## Setup Instructions

### 1. Create a Google Cloud Project

1. Go to the [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project
3. Enable the following APIs:
   - Google Sheets API
   - Google Docs API
   - Google Drive API

### 2. Create a Service Account

1. In your Google Cloud project, go to "IAM & Admin" > "Service Accounts"
2. Click "Create Service Account"
3. Enter a name and description for the service account
4. Grant the following roles:
   - Google Sheets API: "Sheets Editor"
   - Google Docs API: "Docs Editor"
   - Google Drive API: "Drive File Viewer"
5. Click "Create Key" and select JSON format
6. Download the JSON key file

### 3. Set Up Google Sheets for Employee Data

1. Create a new Google Sheet
2. Add a sheet named "Employees" with the following columns:
   - _id (MongoDB ID) - This is automatically generated by MongoDB when an employee is created in the database. For new employees created in the sheet, leave this field blank and it will be filled automatically when the system syncs with the database. For existing employees, this field should contain the MongoDB ObjectId (a 24-character hexadecimal string, e.g., "507f1f77bcf86cd799439011") that uniquely identifies the employee in the database.
   - user (User ID) - This is the MongoDB ID of the user account associated with this employee. This field links the employee profile to a user account in the system. For new employees created in the sheet, you can leave this blank if there's no associated user yet, or fill it with a valid user ID if you want to link to an existing user.
   - fullName
   - photo
   - backgroundStory
   - rank
   - department
   - joinDate
   - specializations (comma-separated)
   - certifications (comma-separated)
   - contactInfo (JSON string) - This should be a valid JSON string containing contact information. Example format: {"discord": "username#1234", "rsiHandle": "handle", "email": "user@example.com"}
   - isActive
   - lastActive
3. Share the sheet with the service account email (with Editor permissions)
4. Copy the Sheet ID from the URL (the long string between /d/ and /edit in the URL)

#### Finding MongoDB IDs for Existing Employees

If you need to reference existing employees in the Google Sheet, you can find their MongoDB IDs in one of these ways:

1. **From the API**: Make a GET request to `/api/employee-portal/employees` with proper authentication. The response will include the `_id` field for each employee.
   ```
   curl -X GET http://your-server:8080/api/employee-portal/employees -H "Authorization: Bearer your-jwt-token"
   ```

2. **From the Database**: If you have direct access to the MongoDB database, you can query the `employees` collection.
   ```
   db.employees.find({}, {_id: 1, fullName: 1})
   ```

3. **From the Sheet**: If the Google Sheet has already been synced with the database, it will contain the MongoDB IDs for existing employees. The first sync will populate these IDs automatically.

#### Understanding Two-Way Sync Behavior

The employee data synchronization works in both directions:

1. **Database to Sheet**: When the API endpoint is accessed, existing employees in the database are written to the Google Sheet, including their MongoDB IDs.

2. **Sheet to Database**: 
   - For existing employees (with an _id): Changes made in the sheet will update the corresponding employee in the database.
   - For new employees (without an _id): New rows added to the sheet will be created as new employees in the database, and the generated MongoDB ID will be written back to the sheet.

This two-way sync ensures that changes made in either system are reflected in the other. The sync happens automatically when the `/api/employee-portal/employees` endpoint is accessed.

### 4. Set Up Google Docs for Other Content

#### Operations Document

1. Create a new Google Doc for operations
2. Format the document with sections separated by "---OPERATION---"
3. For each operation section, include:
   - Title (first line)
   - Description (second line)
   - Content (remaining lines)
4. Share the document with the service account email (with Editor permissions)
5. Copy the Document ID from the URL

#### Career Paths Document

1. Create a new Google Doc for career paths
2. Format the document with sections separated by "---CAREER-PATH---"
3. For each career path section, include:
   - Department name (first line)
   - Description (second line)
   - Ranks section (starting with "---RANKS---")
   - For each rank, include a section starting with "---RANK---" followed by:
     - Title
     - Description
     - Level (number)
     - Paygrade
     - Responsibilities (comma-separated)
     - Requirements (comma-separated)
4. Share the document with the service account email (with Editor permissions)
5. Copy the Document ID from the URL

#### Events Document

1. Create a new Google Doc for events
2. Format the document with sections separated by "---EVENT---"
3. For each event section, include:
   - Title (first line)
   - Description (second line)
   - Event Type (third line, one of: mission, training, social, meeting, other)
   - Location (fourth line)
   - Start Date (fifth line, in ISO format: YYYY-MM-DD)
   - End Date (sixth line, optional, in ISO format: YYYY-MM-DD)
4. Share the document with the service account email (with Editor permissions)
5. Copy the Document ID from the URL

### 5. Update Environment Variables

Update your `.env` file with the following variables:

```
# Google API Configuration
GOOGLE_CREDENTIALS_JSON={"type":"service_account","project_id":"your-project-id","private_key_id":"your-private-key-id","private_key":"-----BEGIN PRIVATE KEY-----\nYOUR_PRIVATE_KEY_HERE\n-----END PRIVATE KEY-----\n","client_email":"your-service-account@your-project-id.iam.gserviceaccount.com","client_id":"your-client-id","auth_uri":"https://accounts.google.com/o/oauth2/auth","token_uri":"https://oauth2.googleapis.com/token","auth_provider_x509_cert_url":"https://www.googleapis.com/oauth2/v1/certs","client_x509_cert_url":"https://www.googleapis.com/robot/v1/metadata/x509/your-service-account%40your-project-id.iam.gserviceaccount.com"}

# Google Sheets Document IDs
GOOGLE_SHEETS_EMPLOYEE_ID=your-google-sheets-id

# Google Docs Document IDs
GOOGLE_DOCS_OPERATIONS_ID=your-operations-doc-id
GOOGLE_DOCS_CAREER_PATHS_ID=your-career-paths-doc-id
GOOGLE_DOCS_EVENTS_ID=your-events-doc-id
```

#### Important Notes About Credentials Format:

1. The `GOOGLE_CREDENTIALS_JSON` value must be a valid JSON string containing all required fields, especially `client_email` and `private_key`.
2. Do NOT enclose the JSON in quotes (either single or double).
3. The `private_key` field must include the full private key, including the `-----BEGIN PRIVATE KEY-----` and `-----END PRIVATE KEY-----` lines.
4. Line breaks in the private key must be represented as `\n` characters.
5. If you're copying from the downloaded JSON file, make sure to:
   - Remove any extra spaces or line breaks
   - Replace actual line breaks in the private key with `\n` characters
   - Remove any enclosing quotes around the entire JSON

#### Example of Properly Formatted Credentials:

```
GOOGLE_CREDENTIALS_JSON={"type":"service_account","project_id":"my-project-123456","private_key_id":"abcdef1234567890abcdef1234567890abcdef12","private_key":"-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC7VJTUt9Us8cKj\nMzEfYyjiWA4R4/M2bS1GB4t7NXp98C3SC6dVMvDuictGeurT8jNbvJZHtCSuYEvu\nNMoSfm76oqFvAp8Gy0iz5sxjZmSnXyCdPEovGhLa0VzMaQ8s+CLOyS56YyCFGeJZ\n...[rest of the key]...\nHBrawmOICeX0FyqmM8GQV8pn5LpPjzoUYuEA9UI9kkz8tQYHZALQUv4QCOXgnYmO\nPwIDAQAB\n-----END PRIVATE KEY-----\n","client_email":"my-service-account@my-project-123456.iam.gserviceaccount.com","client_id":"123456789012345678901","auth_uri":"https://accounts.google.com/o/oauth2/auth","token_uri":"https://oauth2.googleapis.com/token","auth_provider_x509_cert_url":"https://www.googleapis.com/oauth2/v1/certs","client_x509_cert_url":"https://www.googleapis.com/robot/v1/metadata/x509/my-service-account%40my-project-123456.iam.gserviceaccount.com"}
```

## Usage

Once the integration is set up, the application will automatically:

1. Fetch employee data from the Google Sheet when the `/api/employee-portal/employees` endpoint is accessed
2. Fetch operations content from the Google Doc when the `/api/employee-portal/operations` endpoint is accessed
3. Fetch career paths content from the Google Doc when the `/api/employee-portal/career-paths` endpoint is accessed
4. Fetch events content from the Google Doc when the `/api/employee-portal/events` endpoint is accessed

### Updating Content

To update content:

1. **Employee Data**: Edit the Google Sheet directly. Changes will be reflected in the application the next time the employees endpoint is accessed.
2. **Operations, Career Paths, Events**: Edit the respective Google Docs. Changes will be reflected in the application the next time the corresponding endpoint is accessed.

### Authentication

The API requires authentication for most endpoints. You can authenticate your requests in one of two ways:

1. **Using the Authorization header with Bearer token** (recommended):
   ```
   Authorization: Bearer your-jwt-token
   ```

2. **Using the x-auth-token header**:
   ```
   x-auth-token: your-jwt-token
   ```

You can obtain a JWT token by logging in through the `/api/auth/login` endpoint:
```
curl -X POST http://your-server:8080/api/auth/login -H "Content-Type: application/json" -d '{"username":"your-username","password":"your-password"}'
```

The response will include a token that you can use for subsequent requests.

### Testing the Integration

After setting up the integration, follow these steps to verify that everything is working correctly:

1. **Test Employee Data Integration**:
   - Add or modify an employee record in your Google Sheet
   - Access the `/api/employee-portal/employees` endpoint
   - Verify that the changes appear in the response
   - Example test command:
     ```
     curl -X GET http://your-server:8080/api/employee-portal/employees -H "Authorization: Bearer your-jwt-token"
     ```

2. **Test Operations Content Integration**:
   - Add or modify an operation in your Google Doc
   - Access the `/api/employee-portal/operations` endpoint
   - Verify that the changes appear in the response
   - Example test command:
     ```
     curl -X GET http://your-server:8080/api/employee-portal/operations -H "Authorization: Bearer your-jwt-token"
     ```

3. **Test Career Paths Integration**:
   - Add or modify a career path in your Google Doc
   - Access the `/api/employee-portal/career-paths` endpoint
   - Verify that the changes appear in the response
   - Example test command:
     ```
     curl -X GET http://your-server:8080/api/employee-portal/career-paths -H "Authorization: Bearer your-jwt-token"
     ```

4. **Test Events Integration**:
   - Add or modify an event in your Google Doc
   - Access the `/api/employee-portal/events` endpoint
   - Verify that the changes appear in the response
   - Example test command:
     ```
     curl -X GET http://your-server:8080/api/employee-portal/events -H "Authorization: Bearer your-jwt-token"
     ```

5. **Verify Two-Way Sync for Employee Data**:
   - The system should not only read from Google Sheets but also update the sheet with any changes made through the API
   - Create or update an employee through the API:
     ```
     curl -X POST http://your-server:8080/api/employee-portal/employees -H "Authorization: Bearer your-jwt-token" -H "Content-Type: application/json" -d '{"fullName":"Test Employee","rank":"Recruit","department":"Testing"}'
     ```
   - Check your Google Sheet to verify the changes were synced back

## Troubleshooting

If you encounter issues with the integration, follow these steps to diagnose and fix common problems:

### Common Issues and Solutions

1. **API Endpoints Not Working**
   - Check server logs for specific error messages
   - Verify that the server is running and accessible
   - Test the basic API endpoint at `/api/employee-portal` to confirm the routes are working
   - Make sure you're accessing the correct endpoints:
     - `/api/employee-portal/employees` for employee data
     - `/api/employee-portal/operations` for operations content
     - `/api/employee-portal/career-paths` for career paths content
     - `/api/employee-portal/events` for events content

2. **Authentication Errors**
   - Ensure the `GOOGLE_CREDENTIALS_JSON` in your `.env` file is properly formatted (see notes above)
   - Check that the service account has the correct permissions on the Google Sheets and Google Docs
   - Verify that the service account is active in your Google Cloud Console
   - Make sure the APIs (Sheets, Docs, Drive) are enabled in your Google Cloud project

3. **Document Access Issues**
   - Confirm that all document IDs in the `.env` file are correct
   - Ensure each document is shared with the service account email address
   - Check that the service account has Editor permissions on the documents
   - Verify that the documents exist and are accessible

4. **Content Not Updating**
   - Make sure your documents follow the exact formatting guidelines described above
   - Check that the sheet has a tab named "Employees" with the correct column headers
   - Verify that the Google Docs use the correct section separators (e.g., "---OPERATION---")
   - Remember that content is only synced when the corresponding endpoint is accessed

### Debugging Steps

1. **Check Server Logs**
   - Look for error messages related to Google API initialization or authentication
   - Common error patterns include:
     - "Error parsing Google credentials JSON" - indicates malformed credentials
     - "Missing required fields in Google credentials" - indicates incomplete credentials
     - "Error initializing Google Sheets/Docs API" - indicates authentication issues
     - "Error fetching document content" - indicates document access or format issues

2. **Test API Endpoints Directly**
   - Use a tool like Postman or curl to test the API endpoints directly
   - Example curl command:
     ```
     curl -X GET http://your-server:8080/api/employee-portal/employees -H "Authorization: Bearer your-jwt-token"
     ```
   - Check the response for any error messages

3. **Verify Document Access**
   - Log in to Google Drive with the service account credentials to verify access
   - Use the Google API Explorer to test API calls directly:
     - [Sheets API Explorer](https://developers.google.com/sheets/api/reference/rest)
     - [Docs API Explorer](https://developers.google.com/docs/api/reference/rest)

4. **Restart the Server**
   - After making changes to the `.env` file, restart the server to apply the changes
   - Use the provided scripts: `npm run pm2-restart` or `./simple-start.sh`

## Security Considerations

The service account credentials in the `.env` file provide access to your Google Sheets and Google Docs. Keep these credentials secure and never commit them to version control.
